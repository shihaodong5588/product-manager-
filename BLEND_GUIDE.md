# 以图生图功能使用指南

## 🎯 功能概述

**以图生图（Blend）**功能可以将你的原型画布设计与参考图片混合，利用 Midjourney 生成全新的原型图。这个功能特别适合：
- 为黑白线框图添加色彩和样式
- 将工业设计与参考风格结合
- 快速生成多种设计变体

---

## ✨ 已实现的功能

### 1. Midjourney Blend API ✅
- 在 `lib/ai/midjourney-image.ts` 中添加了 `blend()` 方法
- 支持 2-5 张图片混合
- 支持 3 种比例：竖版 (2:3)、方形 (1:1)、横版 (3:2)

### 2. 画布导出工具 ✅
- 创建了 `lib/canvas-export.ts` 工具库
- 支持导出为 PNG/JPEG 格式
- 支持文件与 URL 转 base64
- 支持直接下载图片

### 3. 以图生图 API ✅
- 新增 `/api/prototypes/blend` 端点
- 自动保存混合结果到数据库
- 支持关联项目和需求

### 4. 用户界面 ✅
- 在画布编辑页面添加"导出图片"按钮
- 在画布编辑页面添加"以图生图"按钮
- 创建了 `BlendDialog` 对话框组件
- 支持上传参考图片
- 实时预览两张图片

---

## 📖 使用步骤

### 步骤 1：创建画布设计

1. 访问 `http://localhost:3000/canvas/new`
2. 从左侧组件库添加组件
3. 拖拽组件布局你的界面
4. 点击 **"保存"** 保存设计

### 步骤 2：导出画布图片（可选）

如果你想先看看画布的样子：
1. 点击顶部工具栏的 **"导出图片"** 按钮
2. 图片会自动下载到你的电脑

### 步骤 3：启动以图生图

1. 在画布编辑页面，点击 **"以图生图"** 按钮
2. 系统会自动导出画布为图片并打开对话框

### 步骤 4：上传参考图片

1. 在对话框中，点击右侧的上传区域
2. 选择一张参考图片（色彩方案、风格参考等）
3. 支持 JPG、PNG 格式，最大 10MB

### 步骤 5：配置生成选项

1. **标题**：输入生成图片的标题（必填）
2. **描述**：添加描述信息（可选）
3. **图片比例**：选择竖版/方形/横版

### 步骤 6：开始生成

1. 点击 **"开始混合生成"** 按钮
2. 等待 Midjourney 生成（通常 30-60 秒）
3. 生成成功后自动跳转到原型图列表
4. 在 `/prototypes` 页面查看结果

---

## 🎨 使用场景示例

### 场景 1：为线框图添加工业风格

**画布设计**：
- 黑白线框的压机界面
- 包含曲线图、参数显示等组件

**参考图片**：
- 一张绿色荧光工业界面的截图
- 或者 Kistler/Promess 的界面照片

**结果**：
- Midjourney 会生成带有工业绿色风格的界面
- 保留原有布局，添加色彩和材质

### 场景 2：添加真实感

**画布设计**：
- 简单的组件布局

**参考图片**：
- 真实的工业控制面板照片
- 带有金属质感和按钮细节

**结果**：
- 更真实的原型图
- 带有金属质感和细节

### 场景 3：风格迁移

**画布设计**：
- 你的设计布局

**参考图片**：
- 你喜欢的任何设计风格
- 例如：科技感、复古风、简约风

**结果**：
- 结合两者的新设计

---

## 🔧 技术细节

### API 调用

```typescript
// 使用 Midjourney Blend
const result = await midjourneyService.blend({
  images: [
    'data:image/png;base64,...',  // 画布图片
    'data:image/jpeg;base64,...', // 参考图片
  ],
  dimensions: 'SQUARE', // PORTRAIT | SQUARE | LANDSCAPE
})
```

### 数据库保存

```typescript
{
  generationType: 'blend',
  platform: 'industrial',
  styleType: 'industrial_hmi',
  imageUrl: result.imageUrl,
  taskId: result.metadata.taskId,
  modelUsed: 'midjourney-blend',
  status: 'final'
}
```

---

## 💡 使用技巧

### 1. 选择好的参考图

- ✅ 清晰、高分辨率的图片
- ✅ 色彩鲜明、风格明确
- ✅ 与你想要的效果接近
- ❌ 避免模糊、低质量的图片
- ❌ 避免过于复杂的图片

### 2. 画布设计建议

- 确保画布组件布局清晰
- 不要留太多空白
- 组件之间保持合理间距
- 文字清晰可读

### 3. 比例选择

- **横版 (3:2)**：适合显示器界面
- **方形 (1:1)**：社交媒体、展示用
- **竖版 (2:3)**：手机界面、平板

---

## ⚙️ 配置要求

确保 `.env` 文件中配置了 Midjourney API：

```env
MIDJOURNEY_API_KEY=your_api_key_here
MIDJOURNEY_API_URL=https://api.qinzhiai.com
```

---

## 🎯 快速测试

### 最简单的测试流程：

1. **打开编辑页面**
   ```
   http://localhost:3000/canvas/new
   ```

2. **添加几个组件**
   - 添加一个曲线图
   - 添加两个参数显示

3. **保存设计**
   - 填写标题：测试设计
   - 点击保存

4. **点击"以图生图"**
   - 上传任意一张工业界面图片作为参考
   - 点击"开始混合生成"

5. **查看结果**
   - 等待生成完成
   - 在原型图列表查看混合结果

---

## 🐛 故障排除

### 问题 1：画布为空无法生成
**解决**：确保画布中至少添加了一个组件

### 问题 2：参考图片上传失败
**解决**：
- 检查图片格式（仅支持 JPG、PNG）
- 检查文件大小（最大 10MB）
- 尝试压缩图片后再上传

### 问题 3：生成失败
**解决**：
- 检查 Midjourney API 密钥是否正确
- 查看控制台日志获取详细错误信息
- 确保网络连接正常

### 问题 4：导出图片失败
**解决**：
- 刷新页面重试
- 确保画布已加载完成
- 检查浏览器控制台错误

---

## 📝 相关文件

| 文件 | 说明 |
|------|------|
| `lib/ai/midjourney-image.ts` | Blend API 实现 |
| `lib/canvas-export.ts` | 画布导出工具 |
| `app/api/prototypes/blend/route.ts` | Blend API 端点 |
| `components/blend-dialog.tsx` | 以图生图对话框 |
| `app/canvas/[id]/page.tsx` | 画布编辑页（已集成） |

---

## 🚀 下一步

现在你可以：
1. ✅ 使用画布创建设计
2. ✅ 导出画布为图片
3. ✅ 上传参考图混合生成
4. ✅ 查看和管理生成结果

**立即体验**：`http://localhost:3000/canvas/new`

---

**享受创作！** 🎉
